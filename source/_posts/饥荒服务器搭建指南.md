---
title: 饥荒服务器搭建指南
author: 零度
tags:
	- Game
	- 饥荒
date: 2020-06-09 20:36:43
categories: 环境搭建
abbrlink: ec971c166b7bb240
---

突然有人约我玩不玩饥荒？

突然有人要我搭个服务器？

“我家境贫寒，你能帮帮我嘛？”

只能翻翻阿里云，找到学生优惠，开搞。

<!-- more -->

## 前期准备

- 阿里云学生云服务器ECS（Ubuntu 16.04）
- 一点Linux

## 安装

首先安装依赖，Ubuntu/Debian 64-Bit系统用户使用下述代码

```shell
dpkg --add-architecture i386
apt-get update
apt-get install lib32gcc1
apt-get install lib32stdc++6
apt-get install libcurl4-gnutls-dev:i386
```

接下来创建用户（避免使用root用户）

`adduser dst`

进入`dst`用户并下载SteamCMD

```shell
su - dst
wget https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz
tar -xvzf steamcmd_linux.tar.gz
mkdir server_dst
```

下载完成后进行解压并安装饥荒（编号343050）

```
./steamcmd.sh
login anonymous
force_install_dir /home/dst/server_dst
app_update 343050 validate
quit
```

## 启动并创建Overworld和Cave配置信息

创建两个启动文件分别为`start.sh`和`start2.sh`

在`start.sh`中输入`./dontstarve_dedicated_server_nullrenderer -console -cluster MyDediServer -shard Master`作为地上世界启动文件

在`start2.sh`中输入`./dontstarve_dedicated_server_nullrenderer -console -cluster MyDediServer -shard Caves`作为洞穴世界启动文件

随后依次运行文件`sh start.sh`

并在看到`Your Server Will Not Start`后按`CTRL+C`停止服务

`start2.sh`同理

## 配置

### 获取饥荒服务器token

打开饥荒联机版，点击左下角的Account

在页面中点击右上角——游戏

点击饥荒联机服务器

创建服务器token

### 地图文件配置

创建文件并输入token

```shell
vi /home/dst/.klei/DoNotStarveTogether/MyDediServer/cluster_token.txt
```

在`/home/dst/.klei/DoNotStarveTogether/MyDediServer/Master/`文件夹下创建`worldgenoverride.lua`文件，并在文件中输入以下内容

```lua
return {
    override_enabled = true,
    preset = "SURVIVAL_TOGETHER",       -- "SURVIVAL_TOGETHER", "MOD_MISSING", "SURVIVAL_TOGETHER_CLASSIC", "SURVIVAL_DEFAULT_PLUS", "COMPLETE_DARKNESS", "DST_CAVE", "DST_CAVE_PLUS"
    overrides = {
        -- default is "never", "rare", "default", "often", "always"
  
        -- MISC
        task_set = "default",           -- "classic", "default", "cave_default"
        start_location = "default",     -- "caves", "default", "plus", "darkness"
        world_size = "default",         -- "small", "medium", "default", "huge"
        branching = "default",          -- "never", "least", "default", "most"
        loop = "default",               -- "never", "default", "always"
        autumn = "default",             -- "noseason", "veryshortseason", "shortseason", "default", "longseason", "verylongseason", "random"
        winter = "default",             -- "noseason", "veryshortseason", "shortseason", "default", "longseason", "verylongseason", "random"
        spring = "default",             -- "noseason", "veryshortseason", "shortseason", "default", "longseason", "verylongseason", "random"
        summer = "default",             -- "noseason", "veryshortseason", "shortseason", "default", "longseason", "verylongseason", "random"
        season_start = "default",       -- "default", "winter", "spring", "summer", "autumnorspring", "winterorsummer", "random"
        day = "default",                -- "default", "longday", "longdusk", "longnight", "noday", "nodusk", "nonight", "onlyday", "onlydusk", "onlynight"
        weather = "default",
        earthquakes = "default",
        lightning = "default",
        frograin = "default",
        wildfires = "default",
        touchstone = "default",
        regrowth = "default",           -- "veryslow", "slow", "default", "fast", "veryfast"
        cavelight = "default",          -- "veryslow", "slow", "default", "fast", "veryfast"
        boons = "default",
        prefabswaps_start = "default",  -- "classic", "default", "highly random"
        prefabswaps = "default",        -- "none", "few", "default", "many", "max"
  
        -- RESOURCES
        flowers = "default",
        grass = "default",
        sapling = "default",
        marshbush = "default",
        tumbleweed = "default",
        reeds = "default",
        trees = "default",
        flint = "default",
        rock = "default",
        rock_ice = "default",
        meteorspawner = "default",
        meteorshowers = "default",
        mushtree = "default",
        fern = "default",
        flower_cave = "default",
        wormlights = "default",
  
        -- UNPREPARED
        berrybush = "default",
        carrot = "default",
        mushroom = "default",
        cactus = "default",
        banana = "default",
        lichen = "default",
  
        -- ANIMALS
        rabbits = "default",
        moles = "default",
        butterfly = "default",
        birds = "default",
        buzzard = "default",
        catcoon = "default",
        perd = "default",
        pigs = "default",
        lightninggoat = "default",
        beefalo = "default",
        beefaloheat = "default",
        hunt = "default",
        alternatehunt = "default",
        penguins = "default",
        cave_ponds = "default",
        ponds = "default",
        bees = "default",
        angrybees = "default",
        tallbirds = "default",
        slurper = "default",
        bunnymen = "default",
        slurtles = "default",
        rocky = "default",
        monkey = "default",
  
        -- MONSTERS
        spiders = "default",
        cave_spiders = "default",
        hounds = "default",
        houndmound = "default",
        merm = "default",
        tentacles = "default",
        chess = "default",
        lureplants = "default",
        walrus = "default",
        liefs = "default",
        deciduousmonster = "default",
        krampus = "default",
        bearger = "default",
        deerclops = "default",
        goosemoose = "default",
        dragonfly = "default",
        bats = "default",
        fissure = "default",
        worms = "default",
    },
}
```

同理，在洞穴文件下`/home/dst/.klei/DoNotStarveTogether/MyDediServer/Caves/`也创建`worldgenoverride.lua`，并输入以下内容

```lua
return {
    override_enabled = true,
    preset = "DST_CAVE",                 -- "SURVIVAL_TOGETHER", "MOD_MISSING", "SURVIVAL_TOGETHER_CLASSIC", "SURVIVAL_DEFAULT_PLUS", "COMPLETE_DARKNESS", "DST_CAVE", "DST_CAVE_PLUS"
    overrides = {
        -- defalut is "never", "rare", "default", "often", "always"
  
        -- MISC
        task_set = "cave_default",       -- "classic", "default", "cave_default"
        start_location = "default",      -- "caves", "default", "plus", "darkness"
        world_size = "default",          -- "small", "medium", "default", "huge"
        branching = "default",           -- "never", "least", "default", "most"
        loop = "default",                -- "never", "default", "always"
        autumn = "default",              -- "noseason", "veryshortseason", "shortseason", "default", "longseason", "verylongseason", "random"
        winter = "default",              -- "noseason", "veryshortseason", "shortseason", "default", "longseason", "verylongseason", "random"
        spring = "default",              -- "noseason", "veryshortseason", "shortseason", "default", "longseason", "verylongseason", "random"
        summer = "default",              -- "noseason", "veryshortseason", "shortseason", "default", "longseason", "verylongseason", "random"
        season_start = "default",        -- "default", "winter", "spring", "summer", "autumnorspring", "winterorsummer", "random"
        day = "default",                 -- "default", "longday", "longdusk", "longnight", "noday", "nodusk", "nonight", "onlyday", "onlydusk", "onlynight"
        weather = "default",
        earthquakes = "default",
        lightning = "default",
        frograin = "default",
        wildfires = "default",
        touchstone = "default",
        regrowth = "default",            -- "veryslow", "slow", "default", "fast", "veryfast"
        cavelight = "default",           -- "veryslow", "slow", "default", "fast", "veryfast"
        boons = "default",
        prefabswaps_start = "default",   -- "classic", "default", "highly random"
        prefabswaps = "default",         -- "none", "few", "default", "many", "max"
  
        -- RESOURCES
        flowers = "default",
        grass = "default",
        sapling = "default",
        marshbush = "default",
        tumbleweed = "default",
        reeds = "default",
        trees = "default",
        flint = "default",
        rock = "default",
        rock_ice = "default",
        meteorspawner = "default",
        meteorshowers = "default",
        mushtree = "default",
        fern = "default",
        flower_cave = "default",
        wormlights = "default",
  
        -- UNPREPARED
        berrybush = "default",
        carrot = "default",
        mushroom = "default",
        cactus = "default",
        banana = "default",
        lichen = "default",
  
        -- ANIMALS
        rabbits = "default",
        moles = "default",
        butterfly = "default",
        birds = "default",
        buzzard = "default",
        catcoon = "default",
        perd = "default",
        pigs = "default",
        lightninggoat = "default",
        beefalo = "default",
        beefaloheat = "default",
        hunt = "default",
        alternatehunt = "default",
        penguins = "default",
        cave_ponds = "default",
        ponds = "default",
        bees = "default",
        angrybees = "default",
        tallbirds = "default",
        slurper = "default",
        bunnymen = "default",
        slurtles = "default",
        rocky = "default",
        monkey = "default",
  
        -- MONSTERS
        spiders = "default",
        cave_spiders = "default",
        hounds = "default",
        houndmound = "default",
        merm = "default",
        tentacles = "default",
        chess = "default",
        lureplants = "default",
        walrus = "default",
        liefs = "default",
        deciduousmonster = "default",
        krampus = "default",
        bearger = "default",
        deerclops = "default",
        goosemoose = "default",
        dragonfly = "default",
        bats = "default",
        fissure = "default",
        worms = "default",
    },
}
```

### 通用文件配置

在`/home/dst/.klei/DoNotStarveTogether/MyDediServer/`文件夹下创建`cluster.ini`文件，并根据以下内容自行配置

```
[MISC]
max_snapshots = 6                  # 最大快照数，决定了可回滚的天数
console_enabled = true             # 是否开启控制台
 
[SHARD]
shard_enabled = true               # 服务器共享，要开启洞穴服务器的必须启用
bind_ip = 127.0.0.1                # 服务器监听的地址，当所有实例都运行在同一台机器时，可填写 127.0.0.1，会被 server .ini 覆盖
master_ip = 127.0.0.1              # master 服务器的 IP，针对非 master 服务器，若与 master 服务器运行在同一台机器时，可填写 127.0.0.1，会被 server.ini 覆盖
master_port = 10888                # 监听 master 服务器的 UDP 端口，所有连接至 master 服务器的非 master 服务器必须相同
cluster_key = dst                  # 连接密码，每台服务器必须相同，会被 server.ini 覆盖
 
[STEAM]
steam_group_only = false           # 只允许某 Steam 组的成员加入
steam_group_id = 0                 # 指定某个 Steam 组，填写组 ID
steam_group_admins = false         # 开启后，Steam 组的管理员拥有服务器的管理权限
 
[NETWORK]
offline_server = false             # 离线服务器，只有局域网用户能加入，并且所有依赖于 Steam 的任何功能都无效，比如说饰品掉落
tick_rate = 15                     # 每秒通信次数，越高游戏体验越好，但是会加大服务器负担
whitelist_slots = 0                # 为白名单用户保留的游戏位
cluster_password =                 # 游戏密码，不设置表示无密码
cluster_name = ttionya test        # 游戏房间名称
cluster_description = description  # 游戏房间描述
lan_only_cluster = false           # 局域网游戏
cluster_intention = madness        # 游戏偏好，可选 cooperative, competitive, social, or madness，随便设置，没卵用
 
[GAMEPLAY]
max_players = 16                   # 最大游戏人数
pvp = true                         # 能不能攻击其他玩家，能不能给其他玩家喂屎
game_mode = survival               # 游戏模式，可选 survival, endless or wilderness，与玩家死亡后的负面影响有关
pause_when_empty = false           # 没人服务器暂停，刷天数必备
vote_kick_enabled = false          # 投票踢人
```

### 地上、洞穴独立文件配置

```
[SHARD]
is_master = true /false      # 是否是 master 服务器，只能存在一个 true，其他全是 false
name = caves                 # 针对非 master 服务器的名称
id = ???                     # 随机生成，不用加入该属性
 
[STEAM]
authentication_port = 8766   # Steam 用的端口，确保每个实例都不相同
master_server_port = 27016   # Steam 用的端口，确保每个实例都不相同
 
[NETWORK]
server_port = 10999          # 监听的 UDP 端口，只能介于 10998 - 11018 之间，确保每个实例都不相同
```

在`/home/dst/.klei/DoNotStarveTogether/MyDediServer/Master/`文件夹下修改`server.ini`

```
[SHARD]
is_master = true
 
[STEAM]
authentication_port = 12345
master_server_port = 12346
 
[NETWORK]
server_port = 10999
```

在`/home/dst/.klei/DoNotStarveTogether/MyDediServer/Caves/`文件夹下修改`server.ini`

```
[SHARD]
is_master = false
name = caves
 
[STEAM]
authentication_port = 12347
master_server_port = 12348
 
[NETWORK]
server_port = 11000
```

### Mod下载配置

编辑`/home/dst/server_dst/mods/dedicated_server_mods_setup.lua`文件

去steam创意工坊寻找所需的Mod，并记录Mod的id添加到文件中

```lua
ServerModSetup("458940297")
ServerModSetup("375859599") 
--ServerModCollectionSetup("id")
```

### Mod文件配置

创建`modoverrides.lua`，并输入以下内容

```lua
return {
["workshop-458940297"] = { enabled = true },
["workshop-375859599"] = { enabled = true },
["workshop-444438334"] = { enabled = true,
    configuration_options =
    {
        keybind = 103,
        maxLights = 2,
        backpackCategory = "food"
    }
}
}
```

其中`configuration_options`需要根据自身需求去填写（不建议在此配置，可以去`/home/dst/server_dst/mods/`文件夹下找到对应mod的`workshop-id`下的`modinfo.lua`配置）

配置完成后将文件复制到`Master`和`Caves`文件夹下

## 启动 

### 安装screen

linux下还需要安装screen让你能够多窗口运行

```shell
exit # 返回root用户
apt-get install screen
```

安装完后回到`dst`用户

```shell
su - dst
```

### 重启服务

由于采用screen作为多窗口运行的方式，我们还需要一个重启服务

同样分为地上和洞穴

在` /home/dst/server_dst/bin/`下创建`restart.sh`，并输入以下内容

```bash
#!/bin/sh
# launch of server Overworld

#Path Directory
name_folder="/home/dst/server_dst/bin"

#Command line
start_overworld="sh start.sh"

#Start or Restart the server
screen -dr dst_server1 -X -S quit
cd ${name_folder}
screen -dmS dst_server1 ${start_overworld}
```

在` /home/dst/server_dst/bin/`下创建`restart2.sh`，并输入以下内容

```bash
#!/bin/sh
# launch of server Cave

#Path Directory
name_folder="/home/dst/server_dst/bin"

#Command line
start_cave="sh start2.sh"

#Start or Restart the server
screen -dr dst_server2 -X -S quit
cd ${name_folder}
screen -dmS dst_server2 ${start_cave}
```

运行之后你可以用以下命令查看日志文档输出

```shell
tail -f /home/dst/.klei/DoNotStarveTogether/MyDediServer/Master/server_log.txt
tail -f /home/dst/.klei/DoNotStarveTogether/MyDediServer/Caves/server_log.txt
```

## 定时更新

现在我们要设定每天定时更新文件

在`/home/dst/server_dst/bin/`下创建`update.sh`文件，并输入以下内容

```bash
#update of server
screen -dr dst_server1 -X quit
screen -dr dst_server2 -X quit
cd /home/dst
./steamcmd.sh +login anonymous +force_install_dir /home/dst/server_dst +app_update 343050 validate +quit
sleep 10
sh /home/dst/server_dst/bin/restart.sh
sh /home/dst/server_dst/bin/restart2.sh
```

可以运行检查一下，没有问题就可以进行下一步

我们用crontab进行计划服务

输入`crontab -e`，你能看到

```
Select an editor.  To change later, run 'select-editor'.
  1. /bin/ed
  2. /bin/nano        <---- easiest
  3. /usr/bin/vim.basic
  4. /usr/bin/vim.tiny
```

选择2，将`0 6 * * * sh /home/dst/server_dst/bin/update.sh`复制到文件中，保存并退出

## 关闭服务

退回`root`用户，我们使用`htop`来完成这一任务

```
apt-get install htop
su - dst
htop -u dst
```

随后在列表中找到相应的screen后台，按f9选择后删除

若要再次打开，运行`restart.sh`和`restart2.sh`即可

至此，设置基本结束

还有一些黑名单、白名单等可以参考[饥荒官方指南](https://dontstarve.fandom.com/wiki/Guides/Don't_Starve_Together_Dedicated_Servers)自行进行设置

## 参考资料

1. [V社SteamCMD安装指南](https://developer.valvesoftware.com/wiki/SteamCMD#Linux)
2. [饥荒搭建指南](https://steamcommunity.com/sharedfiles/filedetails/?id=590565473)(需加速器)
3. [饥荒官方指南](https://dontstarve.fandom.com/wiki/Guides/Don't_Starve_Together_Dedicated_Servers)
4. [饥荒联机独立服务器配置](http://blog.ttionya.com/article-1235.html)